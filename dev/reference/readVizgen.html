<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Read Vizgen MERFISH output as SpatialFeatureExperiment — readVizgen • SpatialFeatureExperiment</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Read Vizgen MERFISH output as SpatialFeatureExperiment — readVizgen"><meta name="description" content="This function reads the standard Vizgen MERFISH output into an SFE object.
The coordinates are in microns. Cell centroids are read into
colGeometry &quot;centroids&quot;, and cell segmentations are read into
colGeometry &quot;cellSeg&quot;. The image(s) (polyT, DAPI, and cell boundaries)
are also read as SpatRaster objects so they are not loaded into
memory unless necessary. Because the image's origin is the top left while the
geometry's origin is bottom left, either the image or the geometry needs to
be flipped. Because the image accompanying MERFISH datasets are usually very
large, the coordinates will be flipped so the flipping operation won't load
the entire image into memory. Large datasets with hundreds of thousands of
cells can take a while to read if reading transcript spots as it takes a
while to convert the spots to MULTIPOINT geometries."><meta property="og:description" content="This function reads the standard Vizgen MERFISH output into an SFE object.
The coordinates are in microns. Cell centroids are read into
colGeometry &quot;centroids&quot;, and cell segmentations are read into
colGeometry &quot;cellSeg&quot;. The image(s) (polyT, DAPI, and cell boundaries)
are also read as SpatRaster objects so they are not loaded into
memory unless necessary. Because the image's origin is the top left while the
geometry's origin is bottom left, either the image or the geometry needs to
be flipped. Because the image accompanying MERFISH datasets are usually very
large, the coordinates will be flipped so the flipping operation won't load
the entire image into memory. Large datasets with hundreds of thousands of
cells can take a while to read if reading transcript spots as it takes a
while to convert the spots to MULTIPOINT geometries."><meta name="robots" content="noindex"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SpatialFeatureExperiment</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.7.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/SFE.html">Introduction to the SpatialFeatureExperiment class</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pachterlab/SpatialFeatureExperiment/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Read Vizgen MERFISH output as SpatialFeatureExperiment</h1>
      <small class="dont-index">Source: <a href="https://github.com/pachterlab/SpatialFeatureExperiment/blob/documentation-devel/R/read.R" class="external-link"><code>R/read.R</code></a></small>
      <div class="d-none name"><code>readVizgen.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function reads the standard Vizgen MERFISH output into an SFE object.
The coordinates are in microns. Cell centroids are read into
<code><a href="colGeometries.html">colGeometry</a></code> "centroids", and cell segmentations are read into
<code>colGeometry</code> "cellSeg". The image(s) (polyT, DAPI, and cell boundaries)
are also read as <code>SpatRaster</code> objects so they are not loaded into
memory unless necessary. Because the image's origin is the top left while the
geometry's origin is bottom left, either the image or the geometry needs to
be flipped. Because the image accompanying MERFISH datasets are usually very
large, the coordinates will be flipped so the flipping operation won't load
the entire image into memory. Large datasets with hundreds of thousands of
cells can take a while to read if reading transcript spots as it takes a
while to convert the spots to MULTIPOINT geometries.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">readVizgen</span><span class="op">(</span></span>
<span>  <span class="va">data_dir</span>,</span>
<span>  z <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>  sample_id <span class="op">=</span> <span class="st">"sample01"</span>,</span>
<span>  min_area <span class="op">=</span> <span class="fl">15</span>,</span>
<span>  image <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DAPI"</span>, <span class="st">"PolyT"</span>, <span class="st">"Cellbound"</span><span class="op">)</span>,</span>
<span>  flip <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geometry"</span>, <span class="st">"image"</span>, <span class="st">"none"</span><span class="op">)</span>,</span>
<span>  max_flip <span class="op">=</span> <span class="st">"50 MB"</span>,</span>
<span>  filter_counts <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  add_molecules <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  use_bboxes <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  use_cellpose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  BPPARAM <span class="op">=</span> <span class="fu">SerialParam</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  file_out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"detected_transcripts.parquet"</span><span class="op">)</span>,</span>
<span>  z_option <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"3d"</span>, <span class="st">"split"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-data-dir">data_dir<a class="anchor" aria-label="anchor" href="#arg-data-dir"></a></dt>
<dd><p>Top level output directory.</p></dd>


<dt id="arg-z">z<a class="anchor" aria-label="anchor" href="#arg-z"></a></dt>
<dd><p>Integer, z index to read, or "all", indicating z-planes of the
images and transcript spots to read. While cell segmentation seems to have
multiple z-planes, the segmentation in all z-planes are the same so in
effect the cell segmentatio is only in 2D.</p></dd>


<dt id="arg-sample-id">sample_id<a class="anchor" aria-label="anchor" href="#arg-sample-id"></a></dt>
<dd><p>A <code>character</code> sample identifier, which matches the
<code>sample_id</code> in <code><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-methods.html" class="external-link">imgData</a></code>. The <code>sample_id</code> will also
be stored in a new column in <code><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-colData.html" class="external-link">colData</a></code>, if not already present.
Default = <code>sample01</code>.</p></dd>


<dt id="arg-min-area">min_area<a class="anchor" aria-label="anchor" href="#arg-min-area"></a></dt>
<dd><p>Minimum cell area in square microns. Anything smaller will be
considered artifact or debris and removed.</p></dd>


<dt id="arg-image">image<a class="anchor" aria-label="anchor" href="#arg-image"></a></dt>
<dd><p>Which image(s) to load, can be "DAPI", "PolyT", "Cellbound" or
any combination of them.</p></dd>


<dt id="arg-flip">flip<a class="anchor" aria-label="anchor" href="#arg-flip"></a></dt>
<dd><p>To flip the image, geometry coordinates, or none. Because the
image has the origin at the top left while the geometry has origin at the
bottom left, one of them needs to be flipped for them to match. If one of
them is already flipped, then use "none". The image will not be flipped if
it's GeoTIFF.</p></dd>


<dt id="arg-max-flip">max_flip<a class="anchor" aria-label="anchor" href="#arg-max-flip"></a></dt>
<dd><p>Maximum size of the image allowed to flip the image. Because
the image will be loaded into memory to be flipped. If the image is larger
than this size then the coordinates will be flipped instead.</p></dd>


<dt id="arg-filter-counts">filter_counts<a class="anchor" aria-label="anchor" href="#arg-filter-counts"></a></dt>
<dd><p>Logical, whether to keep cells with counts <code>&gt; 0</code>.</p></dd>


<dt id="arg-add-molecules">add_molecules<a class="anchor" aria-label="anchor" href="#arg-add-molecules"></a></dt>
<dd><p>Logical, whether to add transcripts coordinates to an
object.</p></dd>


<dt id="arg-use-bboxes">use_bboxes<a class="anchor" aria-label="anchor" href="#arg-use-bboxes"></a></dt>
<dd><p>If no segmentation output is present, use
<code>cell_metadata</code> to make bounding boxes instead.</p></dd>


<dt id="arg-use-cellpose">use_cellpose<a class="anchor" aria-label="anchor" href="#arg-use-cellpose"></a></dt>
<dd><p>Whether to read the parquet files from CellPose cell
segmentation. If <code>FALSE</code>, cell segmentation will be read from the HDF5
files. Note that reading HDF5 files for numerous FOVs is very slow.</p></dd>


<dt id="arg-bpparam">BPPARAM<a class="anchor" aria-label="anchor" href="#arg-bpparam"></a></dt>
<dd><p>A <code>BiocParallelParam</code> object specifying parallel
  processing backend and number of threads to use for parallelizable tasks:</p><ol><li><p>To load cell segmentation from HDF5 files from different
  fields of view (FOVs) with multiple cores. A progress bar can be configured
  in the <code>BiocParallelParam</code> object. When there are numerous
  FOVs, reading in the geometries can be time consuming, so we recommend
  using a server and larger number of threads. This argument is not used if
  <code>use_cellpose = TRUE</code> and the parquet file is present.</p></li>
<li><p>To get the largest piece and see if it's larger than <code>min_area</code>
  when there are multiple pieces in the cell segmentation for one cell.</p></li>
</ol></dd>


<dt id="arg-file-out">file_out<a class="anchor" aria-label="anchor" href="#arg-file-out"></a></dt>
<dd><p>Name of file to save the geometry or raster to disk.
Especially when the geometries are so large that it's unwieldy to load
everything into memory. If this file (or directory for multiple files)
already exists, then the existing file(s) will be read, skipping the
processing. When writing the file, extensions supplied are ignored and
extensions are determined based on `dest`.</p></dd>


<dt id="arg-z-option">z_option<a class="anchor" aria-label="anchor" href="#arg-z-option"></a></dt>
<dd><p>What to do with z coordinates. "3d" is to construct 3D
geometries. "split" is to create a separate 2D geometry for each z-plane so
geometric operations are fully supported but some data wrangling is
required to perform 3D analyses. When the z coordinates are not integers,
3D geometries will always be constructed since there are no z-planes to
speak of. This argument does not apply when `spatialCoordsNames` has length
2.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A <code>SpatialFeatureExperiment</code> object.</p>
    </div>
    <div class="section level2">
    <h2 id="note">Note<a class="anchor" aria-label="anchor" href="#note"></a></h2>
    <p>Since the transcript spots file is often very large, we recommend only
  using <code>add_molecules = TRUE</code> on servers with a lot of memory. If
  reading all z-planes, conversion of transcript spot geometry to parquet
  file might fail due to arrow data length limit. In a future version, when
  the transcript spot geometry is large, it will be written to multiple
  separate parquet files which are then concatenated with DuckDB. Also, in a
  future version, the transcript spot processing function might be rewritten
  in C++ to stream the original CSV file so it's not entirely loaded into
  memory.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="va">fp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dir_use</span> <span class="op">&lt;-</span> <span class="fu">SFEData</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SFEData/man/VizgenOutput.html" class="external-link">VizgenOutput</a></span><span class="op">(</span>file_path <span class="op">=</span> <span class="va">fp</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> see ?SFEData and browseVignettes('SFEData') for documentation</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> loading from cache</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> The downloaded files are in /tmp/Rtmpr2gFdA/file24bf7a274d49/vizgen_cellbound </span>
<span class="r-in"><span><span class="va">sfe</span> <span class="op">&lt;-</span> <span class="fu">readVizgen</span><span class="op">(</span><span class="va">dir_use</span>, z <span class="op">=</span> <span class="fl">3L</span>, image <span class="op">=</span> <span class="st">"PolyT"</span>,</span></span>
<span class="r-in"><span>flip <span class="op">=</span> <span class="st">"geometry"</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> &gt;&gt;&gt; 1 `.parquet` files exist:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> /tmp/Rtmpr2gFdA/file24bf7a274d49/vizgen_cellbound/cell_boundaries.parquet</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> &gt;&gt;&gt; using -&gt; /tmp/Rtmpr2gFdA/file24bf7a274d49/vizgen_cellbound/cell_boundaries.parquet</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> &gt;&gt;&gt; Cell segmentations are found in `.parquet` file</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Removing 35 cells with area less than 15</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> &gt;&gt;&gt; filtering geometries to match 1023 cells with counts &gt; 0</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> &gt;&gt;&gt; Checking polygon validity</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Filtering of counts, and addition of molecule coordinates..</span></span></span>
<span class="r-in"><span><span class="va">sfe</span> <span class="op">&lt;-</span> <span class="fu">readVizgen</span><span class="op">(</span><span class="va">dir_use</span>, z <span class="op">=</span> <span class="fl">3L</span>, image <span class="op">=</span> <span class="st">"PolyT"</span>, filter_counts <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>add_molecules <span class="op">=</span> <span class="cn">TRUE</span>, flip <span class="op">=</span> <span class="st">"geometry"</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> &gt;&gt;&gt; 1 `.parquet` files exist:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> /tmp/Rtmpr2gFdA/file24bf7a274d49/vizgen_cellbound/cell_boundaries.parquet</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> &gt;&gt;&gt; using -&gt; /tmp/Rtmpr2gFdA/file24bf7a274d49/vizgen_cellbound/cell_boundaries.parquet</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> &gt;&gt;&gt; Cell segmentations are found in `.parquet` file</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Removing 35 cells with area less than 15</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> &gt;&gt;&gt; filtering `cell_metadata` - keep cells with `transcript_count` &gt; 0</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> &gt;&gt;&gt; filtering geometries to match 1023 cells with counts &gt; 0</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> &gt;&gt;&gt; Checking polygon validity</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> &gt;&gt;&gt; Reading transcript coordinates</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> &gt;&gt;&gt; Converting transcript spots to geometry</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> &gt;&gt;&gt; Writing reformatted transcript spots to disk</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="va">dir_use</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Lambda Moses, Alik Huseynov, Lior Pachter.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer></div>





  </body></html>

